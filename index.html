<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driver Daily Log</title>
  <style>
    :root {
      --bg: #0b1016;
      --panel: #131b24;
      --accent: #198754;
      --danger: #dc3545;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, sans-serif;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }
    .row label {
      flex: 1 0 120px;
      padding: .25rem;
    }
    .row input {
      flex: 2 0 200px;
      padding: .25rem;
      border: 1px solid #444;
      border-radius: 4px;
      background: var(--panel);
      color: #fff;
    }
    .btn {
      display: inline-block;
      padding: .5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: .25rem 0;
      text-align: center;
    }
    .btn-success { background: var(--accent); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .stops { margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
    th, td { border: 1px solid #444; padding: .25rem; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Driver Daily Log</h1>

    <div class="row"><label>Date</label><input type="date" id="date"></div>
    <div class="row"><label>Driver Name</label><input id="driverName" placeholder="Enter driver name"></div>
    <div class="row"><label>Driver Email</label><input id="driverEmail" placeholder="name@example.com"></div>
    <div class="row"><label>Dispatcher Email (CC)</label><input id="dispatcherEmail" placeholder="optional@company.com"></div>
    <div class="row"><label>Truck #</label><input id="truck"></div>

    <div class="row"><label>Start Miles</label><input type="number" id="startMiles"></div>
    <div class="row"><label>End Miles</label><input type="number" id="endMiles"></div>
    <div class="row"><label>Rate Per Mile ($)</label><input type="number" step="0.01" id="ratePerMile"></div>
    <div class="row"><label>Hourly Rate ($)</label><input type="number" step="0.01" id="hourlyRate"></div>
    <div class="row"><label>Total Miles</label><input id="totalMiles" readonly></div>
    <div class="row"><label>Total Value (hrs)</label><input id="totalValue" readonly></div>
    <div class="row"><label>Gross Pay ($)</label><input id="grossPay" readonly></div>

    <div class="stops">
      <button class="btn btn-success" onclick="addStop()">Add Stop</button>
      <table id="stopsTable">
        <thead>
          <tr><th>Type</th><th>Location</th><th>Arrive</th><th>Depart</th><th>Duration</th><th>Value</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
    <button class="btn btn-danger" onclick="resetForm()">Reset</button>
    <button class="btn btn-success" onclick="submitDay()">Submit Day (CSV PDF)</button>
    <p id="status"></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbytifqlMwDxvSBWrfNgO2e55_3y338VrIf6g0XeDZXBbV0DHs2K_l2I2ElWriB8sqhj/exec';

    function addStop() {
      const tbody = document.querySelector('#stopsTable tbody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input></td>
        <td><input></td>
        <td><input type="time"></td>
        <td><input type="time"></td>
        <td><input></td>
        <td><input type="number" step="0.25"></td>
        <td><button onclick="this.closest('tr').remove()">Remove</button></td>
      `;
      tbody.appendChild(row);
    }

    function exportCSV() {
      const rows = [];
      rows.push(["Date","Driver","Email","Truck","Start Miles","End Miles","Rate/Mile","Hourly Rate","Total Miles","Total Value","Gross Pay"]);
      rows.push([
        document.getElementById('date').value,
        document.getElementById('driverName').value,
        document.getElementById('driverEmail').value,
        document.getElementById('truck').value,
        document.getElementById('startMiles').value,
        document.getElementById('endMiles').value,
        document.getElementById('ratePerMile').value,
        document.getElementById('hourlyRate').value,
        document.getElementById('totalMiles').value,
        document.getElementById('totalValue').value,
        document.getElementById('grossPay').value
      ]);
      const csv = rows.map(r => r.join(",")).join("\n");
      return csv;
    }

    async function submitDay() {
      const csv = exportCSV();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(csv, 10, 10);
      const pdfBase64 = doc.output('datauristring').split(',')[1];

      const data = {
        filename: "driver-log.csv.pdf",
        pdfBase64,
        to: document.getElementById('driverEmail').value,
        cc: document.getElementById('dispatcherEmail').value,
        bcc: 'Brian.price@farmersfreightco.com',
        subject: 'Driver Daily Log (CSV PDF)',
        body: 'Attached is your daily log as a CSV PDF export.'
      };

      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
        const text = await res.text();
        document.getElementById('status').innerText = "Submitted: " + text;
      } catch (err) {
        document.getElementById('status').innerText = "Error: " + err;
      }
    }

    function resetForm() {
      document.querySelectorAll("input").forEach(el => el.value = "");
      document.querySelector("#stopsTable tbody").innerHTML = "";
      document.getElementById("status").innerText = "Form reset.";
    }
  </script>
</body>
</html>

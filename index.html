<script>
async function submitPdfEmail(){
  // build CSV rows (reuses your existing helpers/DOM)
  function minToHHMM(min){min=Math.max(0,Math.round(min));return `${Math.floor(min/60)}:${String(min%60).padStart(2,'0')}`;}
  const rows=[];
  rows.push(["Date",logDate.value,"Driver Name",driverName.value,"Driver Email",driverEmail.value,"Truck #",truckNum.value]);
  rows.push(["Start Miles",startMiles.value,"End Miles",endMiles.value,"Start Time",startTime.value,"End Time",endTime.value]);
  rows.push(["Rate/Mile",rateMile.value,"Hourly Rate",rateHour.value,"Gross Pay",grossPay.value]);
  rows.push(["Total Miles",totalMiles.value,"Total Time",totalTime.value,"Total Detention",totalDetention.value,"Total Value",tfootVal.textContent]);
  rows.push([]);
  rows.push(["#","Type","Location","Arrive","Depart","Duration","Detention","Value"]);
  let idx=0; for(const s of stops){ idx++; rows.push([idx,s.type,s.row.querySelector('.loc').value,s.arr,s.dep,minToHHMM(s.durationMins),minToHHMM(s.detentionMins),s.value]); }

  // render CSV rows into a hidden table and make a small PDF image of it
  const host = document.getElementById('csvPreview'); host.innerHTML='';
  const h = document.createElement('h2'); h.textContent = 'Driver Daily Log — CSV Summary'; host.appendChild(h);
  const tbl=document.createElement('table'); host.appendChild(tbl);
  rows.forEach((r,ri)=>{
    const tr=document.createElement('tr');
    r.forEach(c=>{
      const cell=document.createElement(ri>=5?'td':'th');
      cell.textContent=String(c); tr.appendChild(cell);
    });
    tbl.appendChild(tr);
  });

  // Make a compact PDF from the CSV preview only
  const canvas = await html2canvas(host, { scale: 1.5, backgroundColor:'#ffffff' });
  const img = canvas.toDataURL('image/jpeg', 0.82);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const maxW=pageW-40, maxH=pageH-40, k=Math.min(maxW/canvas.width,maxH/canvas.height);
  pdf.addImage(img,'JPEG',20,20,canvas.width*k,canvas.height*k);
  const ab = pdf.output('arraybuffer'); const blob = new Blob([ab],{type:'application/pdf'});
  const csvPdfBase64 = await new Promise(res=>{const fr=new FileReader(); fr.onload=()=>res(String(fr.result).split(',')[1]); fr.readAsDataURL(blob);});

  // email fields
  const datePart = logDate.value || new Date().toISOString().slice(0,10);
  const csvFilename = `driver_log_${datePart}_csv.pdf`;
  const subject = `Driver Daily Log (CSV only) – ${driverName.value || 'Driver'} – ${datePart}`;
  const body = `Driver: ${driverName.value || ''}\nTruck: ${truckNum.value || ''}\nMiles: ${totalMiles.value}\nValue (hrs): ${tfootVal.textContent}\nGross Pay: $${grossPay.value}\n\nAttached: CSV summary as PDF.`;
  const toEmail = (driverEmail.value||'').trim() || 'brian.price@farmersfreightco.com';
  const cc = (ccEmail.value||'').trim();
  const ALWAYS_BCC = 'brian.price@farmersfreightco.com';

  try{
    const form = new FormData();
    // DO NOT append main 'pdfBase64' at all
    form.append('csvFilename', csvFilename);
    form.append('csvPdfBase64', csvPdfBase64);
    form.append('to', toEmail);
    form.append('cc', cc);
    form.append('bcc', ALWAYS_BCC);
    form.append('subject', subject);
    form.append('body', body);

    const resp = await fetch(GAS_URL, { method:'POST', body: form });
    const text = await resp.text(); let json; try{ json = JSON.parse(text); } catch { json = { ok:false, raw:text }; }
    if (resp.ok && json.ok) alert('Submitted! CSV PDF emailed successfully.');
    else alert('Email failed: ' + (json.error || resp.statusText || json.raw || 'Unknown error'));
  } catch(err){
    alert('Network error: ' + err.message);
  }
}
</script>

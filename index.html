<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Driver Daily Log</title>
<style>
  :root { --bg:#0b1016; --panel:#131b24; --muted:#8291a3; --accent:#4cc38a; --danger:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e7eef7;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:24px;margin:6px 0 14px}
  .card{background:var(--panel);border:1px solid #1e2a36;border-radius:12px;padding:14px;margin-bottom:14px}
  label{display:block;font-size:12px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:6px}
  input, select, button{width:100%;padding:10px;border-radius:8px;border:1px solid #263240;background:#0f1620;color:#e7eef7;font-size:15px}
  input[readonly]{opacity:.85}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .totals{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--accent);border:0;color:#08120e;font-weight:700;cursor:pointer;padding:10px 14px;border-radius:10px}
  .btn.secondary{background:#0f1620;color:#e7eef7;border:1px solid #2a394a}
  .btn.danger{background:var(--danger);color:#1b0d0d}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .status{margin-left:auto;font-size:12px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border-top:1px solid #233142;padding:8px;text-align:left}
  th{color:#b9c7d6;font-size:12px;text-transform:uppercase;letter-spacing:.05em}
  .right{text-align:right}
  @media (max-width:720px){
    .row4,.totals,.row2,.row3{grid-template-columns:1fr}
    .status{width:100%;margin-top:6px}
  }
</style>
<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
</head>
<body>
<div class="wrap" id="logRoot">
  <h1>Driver Daily Log</h1>

  <!-- Driver info -->
  <div class="card">
    <div class="row3">
      <div>
        <label>Date</label>
        <input id="logDate" type="date">
      </div>
      <div>
        <label>Driver Name</label>
        <input id="driverName" type="text" placeholder="Enter driver name">
      </div>
      <div>
        <label>Driver Email</label>
        <input id="driverEmail" type="email" placeholder="name@example.com">
      </div>
    </div>
    <div class="row2" style="margin-top:12px">
      <div>
        <label>Truck #</label>
        <input id="truckNum" type="text" placeholder="Enter truck #">
      </div>
      <div>
        <label>Dispatcher Email (optional CC)</label>
        <input id="ccEmail" type="email" placeholder="optional@company.com">
      </div>
    </div>
  </div>

  <!-- Trip header -->
  <div class="card">
    <div class="row4">
      <div>
        <label>Start Miles</label>
        <input id="startMiles" type="number" inputmode="numeric" placeholder="Start miles">
      </div>
      <div>
        <label>End Miles</label>
        <input id="endMiles" type="number" inputmode="numeric" placeholder="End miles">
      </div>
      <div>
        <label>Start Time</label>
        <input id="startTime" type="text" placeholder="HH:MM">
      </div>
      <div>
        <label>End Time</label>
        <input id="endTime" type="text" placeholder="HH:MM">
      </div>
    </div>

    <div class="row2" style="margin-top:12px">
      <div>
        <label>Rate Per Mile ($)</label>
        <input id="rateMile" type="number" step="0.01" placeholder="e.g. 0.50">
      </div>
      <div>
        <label>Hourly Rate ($)</label>
        <input id="rateHour" type="number" step="0.01" placeholder="e.g. 25.00">
      </div>
    </div>

    <div class="totals" style="margin-top:12px">
      <div>
        <label>Total Miles</label>
        <input id="totalMiles" type="text" readonly>
      </div>
      <div>
        <label>Total Time (hh:mm)</label>
        <input id="totalTime" type="text" readonly>
      </div>
      <div>
        <label>Total Detention (hh:mm)</label>
        <input id="totalDetention" type="text" readonly>
      </div>
      <div>
        <label>Gross Pay ($)</label>
        <input id="grossPay" type="text" readonly>
      </div>
    </div>

    <div class="flex" style="margin-top:12px">
      <button class="btn" id="addStop" type="button">+ Add Stop</button>
      <button class="btn secondary" id="exportCsv" type="button">Export CSV</button>
      <button class="btn" id="submitPdfEmail" type="button" title="Create PDF and email">Submit Day (Email PDF)</button>
      <span class="status" id="saveStatus">Not saved</span>
    </div>
  </div>

  <!-- Stops -->
  <div class="card">
    <table id="stopsTable" style="display:none">
      <thead>
        <tr>
          <th>#</th><th>Type</th><th>Location</th><th>Arrive</th><th>Depart</th><th>Duration</th><th>Detention</th><th>Value (hrs)</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><th colspan="6" class="right">Total Detention</th><th id="tfootDet">0:00</th><th id="tfootVal">0</th><th></th></tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function(){
  if (window.__DDL_INIT__) return; window.__DDL_INIT__ = true;

  // === Your Apps Script Web App URL (as requested) ===
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxeGEhnkKh5P_QTl4azHvh2yjnNjrPEVKw-V3GOkcItkhfwhTT3jlQfeYpnOSJuh4Lz/exec';
  const ALWAYS_BCC = 'brian.price@farmersfreightco.com';

  // ---------- Autosave ----------
  const STORAGE_KEY = 'driverDailyLog.autosave.v3';
  const saveStatus = document.getElementById('saveStatus');
  let saveTimer = null;
  const p2 = n => String(n).padStart(2,'0');
  const nowStamp = () => { const d=new Date(); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())} ${p2(d.getHours())}:${p2(d.getMinutes())}`; };

  function scheduleSave(){
    saveStatus.textContent = 'Saving…';
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveNow, 350);
  }
  function saveNow(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(collectState()));
      saveStatus.textContent = `Saved ✓ at ${nowStamp()}`;
    }catch(e){
      saveStatus.textContent = 'Save failed (storage full?)';
    }
  }
  function collectState(){
    return {
      header: {
        logDate: logDate.value || '',
        driverName: driverName.value || '',
        driverEmail: driverEmail.value || '',
        ccEmail: ccEmail.value || '',
        truckNum: truckNum.value || '',
        startMiles: startMiles.value || '',
        endMiles: endMiles.value || '',
        startTime: startTime.value || '',
        endTime: endTime.value || '',
        rateMile: rateMile.value || '',
        rateHour: rateHour.value || ''
      },
      stops: stops.map(s => ({
        type: s.type,
        location: s.row.querySelector('.loc').value || '',
        arr: s.arr || '',
        dep: s.dep || ''
      }))
    };
  }
  function restoreIfAny(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      if (data.header){
        logDate.value   = data.header.logDate   || '';
        driverName.value= data.header.driverName|| '';
        driverEmail.value= data.header.driverEmail|| '';
        ccEmail.value   = data.header.ccEmail   || '';
        truckNum.value  = data.header.truckNum  || '';
        startMiles.value= data.header.startMiles|| '';
        endMiles.value  = data.header.endMiles  || '';
        startTime.value = data.header.startTime || '';
        endTime.value   = data.header.endTime   || '';
        rateMile.value  = data.header.rateMile  || '';
        rateHour.value  = data.header.rateHour  || '';
      }
      if (Array.isArray(data.stops)){
        data.stops.forEach(st => {
          const s = addStop(st.type || 'Pickup');
          s.row.querySelector('.loc').value = st.location || '';
          s.row.querySelector('.arr').value = st.arr || '';
          s.row.querySelector('.dep').value = st.dep || '';
          s._recalc();
        });
      }
      saveStatus.textContent = `Draft loaded • ${nowStamp()}`;
    }catch(e){
      saveStatus.textContent = 'Could not load draft';
    }
  }

  // ---------- Helpers ----------
  function num(v){const n=parseFloat(String(v).replace(/,/g,''));return isNaN(n)?0:n;}
  function tToMin(t){if(!t) return 0;const m=t.match(/^(\d{1,2}):(\d{2})$/); if(!m) return 0; const h=+m[1], mi=+m[2]; return h*60+mi;}
  function minToHHMM(min){min=Math.max(0,Math.round(min));return `${Math.floor(min/60)}:${String(min%60).padStart(2,'0')}`;}
  function spanMin(a,b){let s=tToMin(a), e=tToMin(b);if(e<s) e+=1440;return e-s;}
  function detentionFrom(mins){const over=mins-60;if(over<=0) return 0;return Math.ceil(over/15)*15;}

  // ---------- Elements ----------
  const logDate     = document.getElementById('logDate');
  const driverName  = document.getElementById('driverName');
  const driverEmail = document.getElementById('driverEmail');
  const ccEmail     = document.getElementById('ccEmail');
  const truckNum    = document.getElementById('truckNum');
  const startMiles  = document.getElementById('startMiles');
  const endMiles    = document.getElementById('endMiles');
  const startTime   = document.getElementById('startTime');
  const endTime     = document.getElementById('endTime');
  const rateMile    = document.getElementById('rateMile');
  const rateHour    = document.getElementById('rateHour');

  const totalMiles  = document.getElementById('totalMiles');
  const totalTime   = document.getElementById('totalTime');
  const totalDetention = document.getElementById('totalDetention');
  const grossPay    = document.getElementById('grossPay');

  const table       = document.getElementById('stopsTable');
  const tbody       = table.querySelector('tbody');
  const tfootDet    = document.getElementById('tfootDet');
  const tfootVal    = document.getElementById('tfootVal');

  // ---------- Trip totals & pay ----------
  function calcGrossPay(){
    const miles = num(totalMiles.value);
    const rpm   = num(rateMile.value);
    const hr    = num(rateHour.value);
    const val   = num(tfootVal.textContent);
    const pay   = (miles * rpm) + (hr * val);
    grossPay.value = pay ? pay.toFixed(2) : '';
  }
  function recalcTripTotals(){
    const miles=num(endMiles.value)-num(startMiles.value);
    totalMiles.value=Math.max(0,miles);
    totalTime.value = (startTime.value&&endTime.value) ? minToHHMM(spanMin(startTime.value,endTime.value)) : '';
    const detTotal=stops.reduce((acc,s)=>acc+s.detentionMins,0);
    totalDetention.value=minToHHMM(detTotal);
    calcGrossPay();
    scheduleSave();
  }
  ;['logDate','driverName','driverEmail','ccEmail','truckNum','startMiles','endMiles','startTime','endTime','rateMile','rateHour']
    .forEach(id=>{
      const el=document.getElementById(id);
      el.addEventListener('input', recalcTripTotals);
      el.addEventListener('change', recalcTripTotals);
    });

  // ---------- Stops ----------
  let idCounter=0;
  const stops=[];

  function addStop(initialType='Pickup'){
    idCounter++;
    const tr=document.createElement('tr');
    tr.dataset.id=idCounter;
    tr.innerHTML=`
      <td class="idx"></td>
      <td><select class="type">
        <option>Pickup</option><option>Drop</option><option>Drop & Hook</option><option>Grain</option>
      </select></td>
      <td><input type="text" class="loc" placeholder="Location"></td>
      <td><input type="text" class="arr" placeholder="HH:MM"></td>
      <td><input type="text" class="dep" placeholder="HH:MM"></td>
      <td class="dur">0:00</td>
      <td class="det">0:00</td>
      <td class="val">0</td>
      <td><button type="button" class="btn danger small remove">Remove</button></td>`;
    const s={id:idCounter,type:initialType,row:tr,arr:"",dep:"",durationMins:0,detentionMins:0,value:0,_recalc:null};
    stops.push(s);
    tbody.appendChild(tr);

    const sel=tr.querySelector('.type');
    const arr=tr.querySelector('.arr');
    const dep=tr.querySelector('.dep');
    const loc=tr.querySelector('.loc');
    const dur=tr.querySelector('.dur');
    const det=tr.querySelector('.det');
    const val=tr.querySelector('.val');
    const btn=tr.querySelector('.remove');

    function recalc(){
      s.type=sel.value;
      s.arr=arr.value; s.dep=dep.value;
      s.durationMins=(s.arr&&s.dep)?spanMin(s.arr,s.dep):0;
      s.detentionMins=(s.type==="Pickup"||s.type==="Drop")?detentionFrom(s.durationMins):0;
      dur.textContent=minToHHMM(s.durationMins);
      det.textContent=minToHHMM(s.detentionMins);

      if(s.type==="Drop & Hook"){ s.value=0.25; }
      else if(s.type==="Pickup"||s.type==="Drop"){
        s.value = (s.durationMins<=60) ? 1 : (1 + s.detentionMins/60);
      } else { s.value = (s.durationMins<=60) ? 1 : (1 + s.detentionMins/60); }

      val.textContent=(+s.value).toFixed(2).replace(/\.00$/,'');
      refresh(); scheduleSave();
    }
    s._recalc = recalc;

    sel.addEventListener('change', recalc);
    [arr,dep,loc].forEach(el=>el.addEventListener('input', recalc));
    btn.addEventListener('click', ()=>{
      const i=stops.findIndex(x=>x.id===s.id); if(i>=0) stops.splice(i,1);
      tr.remove(); refresh(); scheduleSave();
    });

    tr.querySelector('.type').value=initialType;
    recalc();
    return s;
  }

  function refresh(){
    let n=0;[...tbody.children].forEach(tr=>{const idx=tr.querySelector('.idx');if(idx) idx.textContent=++n;});
    table.style.display=stops.length?"table":"none";
    const detTotal=stops.reduce((acc,s)=>acc+s.detentionMins,0);
    const valTotal=stops.reduce((acc,s)=>acc+s.value,0);
    tfootDet.textContent=minToHHMM(detTotal);
    tfootVal.textContent=(+valTotal).toFixed(2).replace(/\.00$/,'');
    recalcTripTotals();
  }

  // Buttons
  document.getElementById('addStop').addEventListener('click', ()=>{ addStop('Pickup'); });

  document.getElementById('exportCsv').addEventListener('click',()=>{
    const rows=[];
    rows.push(["Date",logDate.value,"Driver Name",driverName.value,"Driver Email",driverEmail.value,"Truck #",truckNum.value]);
    rows.push(["Start Miles",startMiles.value,"End Miles",endMiles.value,"Start Time",startTime.value,"End Time",endTime.value]);
    rows.push(["Rate/Mile",rateMile.value,"Hourly Rate",rateHour.value,"Gross Pay",grossPay.value]);
    rows.push(["Total Miles",totalMiles.value,"Total Time",totalTime.value,"Total Detention",totalDetention.value,"Total Value",tfootVal.textContent]);
    rows.push([]);
    rows.push(["#","Type","Location","Arrive","Depart","Duration","Detention","Value"]);

    let idx=0;
    for(const s of stops){
      idx++;
      rows.push([idx,s.type,s.row.querySelector('.loc').value,s.arr,s.dep,minToHHMM(s.durationMins),minToHHMM(s.detentionMins),s.value]);
    }
    const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='driver_log.csv';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  });

  // ---- Submit Day (PDF → Email via Apps Script) ----
  async function submitPdfEmail(){
    const { jsPDF } = window.jspdf;
    const rootEl = document.getElementById('logRoot');

    // Render the visible app to an image
    const canvas = await html2canvas(rootEl, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL('image/png');

    // Build a single-page PDF (scaled to fit A4)
    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const maxW = pageW - 40, maxH = pageH - 40;
    let w = canvas.width, h = canvas.height, k = Math.min(maxW/w, maxH/h);
    pdf.addImage(imgData, 'PNG', 20, 20, w*k, h*k);

    // Blob → base64
    const arrayBuffer = pdf.output('arraybuffer');
    const blob = new Blob([arrayBuffer], {type:'application/pdf'});
    const pdfBase64 = await new Promise(res=>{
      const fr=new FileReader();
      fr.onload=()=>res(String(fr.result).split(',')[1]);
      fr.readAsDataURL(blob);
    });

    const datePart = logDate.value || new Date().toISOString().slice(0,10);
    const filename = `driver_log_${datePart}.pdf`;
    const subject  = `Driver Daily Log – ${driverName.value || 'Driver'} – ${datePart}`;
    const body     = `Driver: ${driverName.value || ''}\nTruck: ${truckNum.value || ''}\nMiles: ${totalMiles.value}\nValue (hrs): ${tfootVal.textContent}\nGross Pay: $${grossPay.value}\n\nAttached is today's Driver Daily Log.`;

    const toEmail = (driverEmail.value || '').trim() || ALWAYS_BCC;  // fall back so something is sent
    const cc      = (ccEmail.value || '').trim();

    try{
      const resp = await fetch(GAS_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          filename, pdfBase64,
          to: toEmail,
          cc, bcc: ALWAYS_BCC,
          subject, body
        })
      });
      const json = await resp.json().catch(()=>({}));
      if (resp.ok && (json.ok || json.sentTo)) {
        alert('Submitted! PDF emailed successfully.');
      } else {
        alert('Could not send email: ' + (json.error || resp.statusText));
      }
    }catch(err){
      alert('Network error sending email: ' + err.message);
    }
  }
  document.getElementById('submitPdfEmail').addEventListener('click', submitPdfEmail);

  // Init
  restoreIfAny();
  recalcTripTotals();
});
</script>
</body>
</html>

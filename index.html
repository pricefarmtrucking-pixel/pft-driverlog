<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Daily Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background:#111;
      color:#eee;
      font-family: Arial, sans-serif;
      margin:0;
      padding:20px;
    }
    h1 { text-align:center; }
    label { display:block; margin-top:8px; }
    input, select {
      width:100%;
      padding:6px;
      margin-top:2px;
      border-radius:4px;
      border:1px solid #444;
      background:#222;
      color:#eee;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
    }
    th, td {
      border:1px solid #444;
      padding:6px;
      text-align:center;
    }
    button {
      margin:5px 2px;
      padding:8px 12px;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    .btn-green { background:#2e8b57; color:#fff; }
    .btn-red   { background:#b22222; color:#fff; }
    .btn-blue  { background:#1e90ff; color:#fff; }
    #status { margin-top:10px; font-size:0.9em; color:#6f6; }
  </style>
</head>
<body>
  <h1>Driver Daily Log</h1>

  <form id="logForm">
    <label>Date <input type="date" id="date"></label>
    <label>Driver Name <input type="text" id="driverName" placeholder="Enter driver name"></label>
    <label>Driver Email <input type="email" id="driverEmail" placeholder="name@example.com"></label>
    <label>Dispatcher Email (CC) <input type="email" id="dispatcherEmail" placeholder="optional@company.com"></label>
    <label>Truck # <input type="text" id="truck"></label>
    <label>Start Miles <input type="number" id="startMiles"></label>
    <label>End Miles <input type="number" id="endMiles"></label>
    <label>Rate Per Mile ($) <input type="number" step="0.01" id="ratePerMile"></label>
    <label>Hourly Rate ($) <input type="number" step="0.01" id="hourlyRate"></label>
    <label>Total Miles <input type="number" id="totalMiles" readonly></label>
    <label>Total Value (hrs) <input type="number" id="totalValue" readonly></label>
    <label>Gross Pay ($) <input type="number" id="grossPay" readonly></label>
  </form>

  <button id="addStop" class="btn-green">Add Stop</button>

  <table id="stopsTable">
    <thead>
      <tr>
        <th>Type</th>
        <th>Location</th>
        <th>Arrive</th>
        <th>Depart</th>
        <th>Duration</th>
        <th>Value</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportCSV" class="btn-blue">Export CSV</button>
  <button id="resetForm" class="btn-red">Reset</button>
  <button id="submitDay" class="btn-green">Submit Day (CSV PDF)</button>

  <div id="status"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbww9vbI07fesck9EXleFnHYcBrKESIORkqS3hjokh-LMaKJhWxyGe7FF60BzkS-IU53/exec';
    const ALWAYS_BCC = 'brian.price@farmersfreightco.com';

    const form = document.getElementById('logForm');
    const stopsTable = document.querySelector('#stopsTable tbody');
    const statusDiv = document.getElementById('status');

    // Autosave/load
    function saveData() {
      localStorage.setItem('driverLog', JSON.stringify(getFormData()));
      statusDiv.textContent = 'Saved at ' + new Date().toLocaleTimeString();
    }
    function loadData() {
      const saved = localStorage.getItem('driverLog');
      if (!saved) return;
      const data = JSON.parse(saved);
      Object.keys(data).forEach(k => {
        if (form[k]) form[k].value = data[k];
      });
    }

    function getFormData() {
      return {
        date: document.getElementById('date').value,
        driverName: document.getElementById('driverName').value,
        driverEmail: document.getElementById('driverEmail').value,
        dispatcherEmail: document.getElementById('dispatcherEmail').value,
        truck: document.getElementById('truck').value,
        startMiles: document.getElementById('startMiles').value,
        endMiles: document.getElementById('endMiles').value,
        ratePerMile: document.getElementById('ratePerMile').value,
        hourlyRate: document.getElementById('hourlyRate').value,
        totalMiles: document.getElementById('totalMiles').value,
        totalValue: document.getElementById('totalValue').value,
        grossPay: document.getElementById('grossPay').value
      };
    }

    // Calculate totals
    function calculateTotals() {
      const start = parseFloat(document.getElementById('startMiles').value) || 0;
      const end = parseFloat(document.getElementById('endMiles').value) || 0;
      const rate = parseFloat(document.getElementById('ratePerMile').value) || 0;
      const totalMiles = Math.max(0, end - start);
      document.getElementById('totalMiles').value = totalMiles;
      document.getElementById('grossPay').value = (totalMiles * rate).toFixed(2);
    }

    ['startMiles','endMiles','ratePerMile'].forEach(id=>{
      document.getElementById(id).addEventListener('input', ()=>{ calculateTotals(); saveData(); });
    });
    form.addEventListener('input', saveData);

    // Stops
    document.getElementById('addStop').addEventListener('click', ()=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input></td>
        <td><input></td>
        <td><input type="time"></td>
        <td><input type="time"></td>
        <td><input></td>
        <td><input></td>
        <td><button class="btn-red">Delete</button></td>
      `;
      tr.querySelector('button').onclick = ()=>tr.remove();
      stopsTable.appendChild(tr);
      saveData();
    });

    // CSV
    function makeCSV() {
      const data = getFormData();
      let rows = [['Field','Value']];
      Object.keys(data).forEach(k => rows.push([k,data[k]]));
      rows.push([]);
      rows.push(['Stops']);
      rows.push(['Type','Location','Arrive','Depart','Duration','Value']);
      stopsTable.querySelectorAll('tr').forEach(tr=>{
        const vals = [...tr.querySelectorAll('input')].map(i=>i.value);
        if (vals.length) rows.push(vals);
      });
      return rows.map(r=>r.join(',')).join('\n');
    }

    document.getElementById('exportCSV').addEventListener('click', ()=>{
      const blob = new Blob([makeCSV()],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='driver_log.csv'; a.click();
    });

    // Reset
    document.getElementById('resetForm').addEventListener('click', ()=>{
      if (confirm("Clear all data?")) {
        localStorage.removeItem('driverLog');
        form.reset();
        stopsTable.innerHTML='';
        statusDiv.textContent='Reset.';
      }
    });

    // Submit
    document.getElementById('submitDay').addEventListener('click', async ()=>{
      try {
        const csv = makeCSV();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const lines = csv.split('\n');
        let y = 10;
        lines.forEach(line=>{
          doc.text(line,10,y);
          y+=7;
          if (y>280){ doc.addPage(); y=10; }
        });
        const pdfBase64 = btoa(doc.output('arraybuffer').reduce((d,b)=>d+String.fromCharCode(b),''));

        const fd = new FormData();
        fd.append('to', document.getElementById('driverEmail').value);
        fd.append('cc', document.getElementById('dispatcherEmail').value);
        fd.append('bcc', ALWAYS_BCC);
        fd.append('subject','Driver Daily Log');
        fd.append('body','Attached is the Driver Daily Log.');
        fd.append('csvFilename','driver_log.pdf');
        fd.append('csvPdfBase64', pdfBase64);

        const res = await fetch(GAS_URL,{method:'POST',body:fd});
        const json = await res.json();
        if (json.ok) statusDiv.textContent='E-mail sent with PDF!';
        else statusDiv.textContent='Error: '+json.error;
      } catch(err){
        statusDiv.textContent='Network error: '+err;
      }
    });

    loadData(); calculateTotals();
  </script>
</body>
</html>
